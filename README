тут типо ридмишка
const path = require('path');
require('dotenv').config({ path: path.resolve(__dirname, '../../.env') });

// Проверяем наличие API ключа перед созданием клиента
if (!process.env.OPENROUTER_API_KEY) {
  console.error('Ошибка: OPENROUTER_API_KEY не установлен в переменных окружения');
  console.error('Убедитесь, что файл .env существует в папке server/ и содержит OPENROUTER_API_KEY');
  process.exit(1);
}

const OpenAI = require('openai').default;

const openai = new OpenAI({
  baseURL: process.env.OPENROUTER_BASE_URL || "https://openrouter.ai/api/v1",
  apiKey: process.env.OPENROUTER_API_KEY,
  defaultHeaders: {
    "HTTP-Referer": process.env.OPENROUTER_REFERER || "http://localhost:3000",
    "X-Title": process.env.OPENROUTER_TITLE || "SoundSpace",
  },
});

// Функция для задержки
const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

// Функция с retry логикой
async function createCompletionWithRetry(model, messages, maxRetries = 3) {
  let lastError;
  
  for (let attempt = 0; attempt < maxRetries; attempt++) {
    try {
      const completion = await openai.chat.completions.create({
        model: model,
        messages: messages,
      });
      return completion;
    } catch (error) {
      lastError = error;
      
      // Если это rate limit ошибка
      if (error.status === 429) {
        const retryAfter = error.headers?.['retry-after'] || Math.pow(2, attempt) * 1000;
        console.warn(`Rate limit достигнут. Попытка ${attempt + 1}/${maxRetries}. Повтор через ${retryAfter}ms...`);
        await sleep(retryAfter);
        continue;
      }
      
      // Если это другая ошибка, пробрасываем дальше
      throw error;
    }
  }
  
  throw lastError;
}

async function main() {
  const model = process.env.OPENROUTER_MODEL || "google/gemini-2.0-flash-exp:free";
  
  try {
    const completion = await createCompletionWithRetry(
      model,
      [
        {
          "role": "user",
          "content": [
            {
              "type": "text",
              "text": "What is in this image?"
            },
            {
              "type": "image_url",
              "image_url": {
                "url": "https://live.staticflickr.com/3851/14825276609_098cac593d_b.jpg"
              }
            }
          ]
        }
      ]
    );

    console.log('\n✅ Успешно! Результат:');
    console.log(completion.choices[0].message);
    
  } catch (error) {
    console.error('\n❌ Ошибка при обращении к OpenAI:', error.message);
    
    if (error.status === 401) {
      console.error('Проверьте правильность OPENROUTER_API_KEY в .env файле');
    } else if (error.status === 429) {
      const errorMessage = error.error?.metadata?.raw || error.message;
      console.error(`Rate limit: ${errorMessage}`);
      console.error('\nРекомендации:');
      console.error('1. Подождите несколько минут и попробуйте снова');
      console.error('2. Добавьте свой Google API ключ в OpenRouter:');
      console.error('   https://openrouter.ai/settings/integrations');
    }
    
    throw error;
  }
}

main().catch(error => {
  console.error('\nКритическая ошибка:', error.message);
  process.exit(1);
});